---
title: "CITS4009 - Project 1"
author: "Tong Lan (24056082)"
date: "`r Sys.Date()`"
output: 
  html_document: 
    code_folding: show
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_chunk$set(warning=FALSE)
```

[Video link for introducing the project's Shiny apps]()

# Introduction

*The Premier League (officially known as The Football Association Premier League Limited)* [[1]][ref1] is the highest level of professional football in the English football league system. There are twenty clubs that compete against each other, with each team playing 38 matches, resulting in a total of 380 matches every season. *The Fantasy Premier League (FPL)* is the official fantasy football game of the English Premier League. It is the largest fantasy football game, with over 11.5 million players in 2023. [[2]][ref2] The game was created by ISM (International Sports Multimedia) and is owned and operated by the Premier League. [[3]][ref3]

The dataset used in this project is obtained from [*kaggle.com*](https://www.kaggle.com/), collected by *PAOLO MAZZA*. [[4]][ref4] It is a basic dataset containing the aggregated fantasy premier league data taken from *the official website Fantasy Premier League* [[5]][ref5]. In Fantasy Premier League, players create a fictional team composed of real-life football players and earn points based on their performance statistics or perceived on-field contributions. [[6]][ref6]

This project explores the 2022-23 season FPL data to identify connections and relationships between players' total scoring points, their positions, and values. It focuses especially on the top-scoring players to investigate what makes them perform well in the 2022-23 season. By analyzing and utilizing data from this project, FPL managers can improve their game strategy.

# Loading Data

Load necessary libraries for the project.

```{r library, message=FALSE}
library(tidyverse)
library(shiny)
library(htmltools)
library(fmsb)
library(RColorBrewer)
library(hrbrthemes)
library(viridis)
library(ggrepel)
library(grid)
library(gridExtra)
```

Load the dataset from a CSV file for the project.

```{r data_file, message=FALSE}
path <- "./FPL_Dataset_2022-2023.csv"
fpl_raw_data <- read.csv(path)
```

# Overview Data

To begin, we need to review the input dataset. We can do this by using the `glimpse()` function to get a general overview of the raw data, followed by using the `str()` function to examine the dataset structure. Next, we can use the `summary()` function to get a summary of the dataset. Finally, we can use the `head()` function to take a look at the first six lines of the dataset.

```{r glimpse, results='hide'}
glimpse(fpl_raw_data)
str(fpl_raw_data)
```

The `glimpse()` function and `str()` function show that the dataset has 778 rows and 75 columns and contains continuous and discrete variables of various data types including integer, character, double, etc. The dataset also has missing values(NA) that need to be handled.

```{r summary, results='hide'}
summary(fpl_raw_data)
```

The `summary()` function indicates that each row in the dataset represents a player, resulting in a total of 778 players for the 2022-23 season. The point total for each player ranges from 0 to 272, with an average of 40.78. The cost for each player ranges from 37 to 131, with a median of 45. According to the rule from the official FPL website [[5]][ref5], a player’s value should be between 3.0 and 14.0, and the total budget for 15 selected players is 100. We can note that the cost values are 10 times larger for easier storage in the database. The cost values might be a useful statistic to explore further.

```{r head, results='hide'}
head(fpl_raw_data)
```

Using the `head()` function, we can view the default first 6 rows, which contain various details such as the number of goals, assists, and other statistics for each player.

# Initial Transform

Before starting our exploratory data analysis, we should perform an initial transformation to make the dataset more suitable for further use. As discussed earlier, player costs range from 3.0 to 14.0, which can separate them into three different value levels: **Low**, **Middle**, and **Premium**.

To explore the most important data in FPL, players' total points, we should first examine the key performance data that can award players points. [[8]][ref8] Extract these data from the raw dataset and rename them for ease of exploratory data analysis. After this step, let's take a look at the transformed data for its first 5 rows.

```{r transform_1, echo=TRUE}
# get level function
get_cost_level <- function(cost_bin) {
  level <- levels(cut_interval((fpl_raw_data$now_cost) / 10, 3))
  case_when(
    cost_bin == level[1] ~ "Low",
    cost_bin == level[2] ~ "Middle",
    cost_bin == level[3] ~ "Premium",
    .default = NA
  )
}

# transform data
fpl_data <- fpl_raw_data[c(
  "web_name",
  "team",
  "position",
  "total_points",
  "points_per_game",
  "now_cost",
  "minutes",
  "goals_scored",
  "expected_goals",
  "expected_goals_per_90",
  "assists",
  "expected_assists",
  "expected_assists_per_90",
  "goals_conceded",
  "expected_goals_conceded",
  "expected_goals_conceded_per_90",
  "saves",
  "saves_per_90",
  "clean_sheets",
  "clean_sheets_per_90"
)] %>%
  rename(all_of(
    c(
      Player = "web_name",
      Club = "team",
      Position = "position",
      Points = "total_points",
      Points90 = "points_per_game",
      Cost = "now_cost",
      Minutes = "minutes",
      Goals = "goals_scored",
      xG = "expected_goals",
      xG90 = "expected_goals_per_90",
      Assists = "assists",
      xA = "expected_assists",
      xA90 = "expected_assists_per_90",
      GC = "goals_conceded",
      xGC = "expected_goals_conceded",
      xGC90 = "expected_goals_conceded_per_90",
      Saves = "saves",
      Saves90 = "saves_per_90",
      CS = "clean_sheets",
      CS90 = "clean_sheets_per_90"
    )
  )) %>%
  # cost is 10 times larger because it is easier to store a integer in the database
  # now we can return it to the actual value by diving 10
  mutate(Cost = Cost / 10) %>%
  # separate the player into three group by their values
  mutate(Cost_bin = cut_interval(Cost, 3), .after = Cost) %>%
  # category player level by their values
  mutate(Level = get_cost_level(Cost_bin), .after = Cost_bin)

# remove data: fpl_raw_data to save memory
rm(fpl_raw_data)

# show the table(first six rows)
knitr::kable(fpl_data[1:5,], caption =  "First 5 rows of fpl_data")
```

```{r transform_2, include=FALSE}
Positions <-  c("FWD", "MID", "DEF", "GKP")
Levels <- unique(fpl_data$Level)
Clubs <- unique(fpl_data$Club)
Costs <- seq(from = 4, to = 13.5, by = 0.5)
```

# Exploring Points Distribution

In this sector, we are currently examining the distribution of points among players.

## Points Distribution of Players

The first thing we want to explore is the distribution of points for players, as points are what FPL is all about. To gain a clear insight, we can analyse players who played regularly, which means they played at least 1000 minutes in a single season.

```{r desity}
fpl_data %>%
  filter(Minutes >= 1000) %>%
  ggplot(aes(x = Points)) +
  geom_density(fill = "#69b3a2",
               color = "#e9ecef",
               alpha = 0.6) +
  xlim(0, 300) +
  ggtitle("Points distribution of players") +
  theme_ipsum() +
  theme(plot.title = element_text(size = 20))
```

The density plot reveals that players' total points are typically centered around 80-100 points, although the top player can score over 200 points in a season. According to FPL rules [[7]][ref7], players from different positions have different methods for calculating their scoring points. Therefore, we can group players by position and examine their point distributions.

```{r multiple_desity}
fpl_data %>%
  filter(Minutes >= 1000) %>%
  ggplot(aes(x = Points, group = Position, fill = Position)) +
  geom_density(adjust = 1.5, alpha = 0.6) +
  xlim(0, 300) +
  ggtitle("Points distribution of players") +
  labs(subtitle = "Grouped by Player Position") +
  theme_ipsum() +
  theme(plot.title = element_text(size = 20),
        plot.subtitle = element_text(size = 14))
```

Based on the multiple density plot, it is evident that the distribution of defenders is the most concentrated, resulting in them scoring fewer points than other positions. While goalkeepers have a wider range of points, even the best goalkeeper cannot score very high points. The distribution of midfielders and forwards is similar, but the top forwards have the potential to score the most points in a season.

## Top 30 Players

Once we have a general understanding of the total points earned by players, our next step is to examine the top 30 players.

```{r barplot, fig.height=8}
fpl_data %>%
  arrange(-Points) %>%
  head(30) %>%
  mutate(Player = paste0(Player, " - ", Cost, "m", sep = " ")) %>%
  mutate(Player = fct_reorder(Player, Points)) %>%
  ggplot(aes(x = Player, y = Points, fill = Position)) +
  geom_bar(stat = "identity",
           alpha = 0.8,
           width = 0.8) +
  geom_label(
    aes(y = Points, label = Points),
    position = position_stack(vjust = 1),
    size = 2,
    show.legend = F
  ) +
  ylim(0, 300) +
  coord_flip() +
  scale_color_brewer(palette = 3) +
  ggtitle("Top 30 Players with the Highest Points") +
  xlab("") +
  theme(plot.title = element_text(hjust = .5)) +
  theme_ipsum()
```

The horizontal barplot confirms our observations that the top 6 players, all of whom scored more than 200 points, are midfielders and forwards. Additionally, players who cost more in the same position tend to score better points. This suggests a correlation between points, positions, and values that should be explored in the next step.

## Points, Positions and Values

```{r boxplot}
fpl_data %>%
      ggplot(aes(x = Level, y = Points, fill = Position)) +
      geom_boxplot() +
      stat_summary(
        fun = mean,
        geom = "point",
        shape = 20,
        size = 10,
        color = "#ec7014",
        fill = "#ec7014"
      ) +
      scale_fill_viridis(discrete = TRUE, alpha = 0.6) +
      geom_jitter(color = "black",
                  size = 0.4,
                  alpha = 0.9) +
      ylim(0, 300) +
      xlab("Level") +
      ggtitle("Total points distribution across different levels") + 
      theme_ipsum()
```

It is easy to support all of the observations mentioned below by using the shiny app of this project to explore the FPL data for the 2022-23 season.

Based on the distribution of different levels across various positions, we can draw some observations from the Shiny app. Goalkeepers have the lowest average cost among all positions. However, the boxplot indicates that there are more outlines for GKP than for any other position. This implies that while we spend less on GKP, they may have a higher chance of providing a better reward.

It can be observed that higher level players score a higher mean of points, indicating a positive correlation between overall cost and total points. The fact that all top level players are forwards and midfielders may contribute to this trend, as they have the most attacking resources available to help them score or assist a goal, resulting in a higher number of FPL points.

# Explore Actual and Expected Values

In this sector, we aim to explore both the actual and expected values of players.

## Further Transform

In the next stage, we will try to determine why an elite player can score more points. One way to explore this is to use expected values such as *expected goals (xG)* [[9]][ref9], *expected assists (xA)* [[10]][ref10], and *expected goals conceded (xGC)* [[11]][ref11]. Fortunately, all of this data is included in the original dataset.

As players have varying playing times, it is inaccurate to use actual or expected values directly. Therefore, we will introduce per 90 statistics, which represent values per 90 minutes of play. We will transform Points, Goals, xG, Assists, xA, GoalsConcede, xGC, and Cleansheets into Points per 90, Goals per 90, xG per 90, Assists per 90, xA per 90, GoalsConcede per 90, xGC per 90, and Cleansheets per 90. 

We can also measure how well a player performs by calculating their "diff value," which is based on the difference between their actual performance and their expected performance.

```{r transform_3, results='hide'}
# fpl_data_diff, the next column is based on the result of the last column
# use mutate one time for one column here
fpl_data <- fpl_data %>%
  mutate(xG_diff = Goals - xG, .after = xG,) %>% 
  mutate(xA_diff = Assists - xA, .after = xA) %>%
  mutate(xGC_diff = GC - xGC, .after = xGC) %>%
  mutate(Goals90 = Goals / (Minutes / 90), .before = xG90) %>%
  mutate(xG90_diff = Goals90 - xG90, .after = xG90) %>%
  mutate(Assists90 = Assists / (Minutes / 90), .before = xA90) %>%
  mutate(xA90_diff = Assists90 - xA90, .after = xA90) %>%
  mutate(GC90 = GC / (Minutes / 90), .before = xGC90) %>%
  mutate(xGC90_diff = GC90 - xGC90, .after = xGC90)

# new data table
knitr::kable(fpl_data[1:5, ], caption = "first 5 rows of fpl_data after adding diff and avg_90 data")

# count missing values
missing_values <- apply(is.na(fpl_data), 2, sum)
na_values <- which(missing_values > 0)
# if actual value and expected value are all 0, then the actual value 90 and expected value 90 will be NaN
# if min > 0, give it an average value, others it is 0
#  expected90 values NaN means the player did not play a single minute, make it NA
  fpl_data$Goals90 <- ifelse(is.na(fpl_data$Goals90), 0, fpl_data$Goals90)
  fpl_data$Assists90 <- ifelse(is.na(fpl_data$Assists90), 0, fpl_data$Assists90)
  fpl_data$GC90 <- ifelse(is.na(fpl_data$GC90), 0, fpl_data$GC90)
  fpl_data$xG90_diff <- fpl_data$Goals90 - fpl_data$xG90
  fpl_data$xA90_diff <- fpl_data$Assists90 - fpl_data$xA90
  fpl_data$xGC90_diff <- fpl_data$GC90 - fpl_data$xGC90
# look at the missing values again, it is clean
missing_values <- apply(is.na(fpl_data), 2, sum)

performance_data <- fpl_data[c(
  "Player",
  "Club",
  "Position",
  "Level",
  "Cost",
  "Points",
  "Minutes",
  "Points90",
  "Goals90",
  "xG90",
  "xG90_diff",
  "Assists90",
  "xA90",
  "xA90_diff",
  "GC90",
  "xGC90",
  "xGC90_diff",
  "CS90"
)]
```

## Handle Invalid per 90 Values

Let's begin by examining the distribution of actual per 90 values. The horizontal violin chart allows us to observe that there are outliers present in the actual values that deviate significantly from the others.

```{r horizontal_violin}
# create a new data frame for plot[Cost, Value, Type], which is not a tidy data
# reshape data here, use provide_long() to create a tidy data
performance_data[c(
  "Minutes",
  "Points90",
  "Goals90",
  "Assists90",
  "GC90",
  "CS90"
)] %>%
  pivot_longer (2:6, names_to = "Per90", values_to = "Value") %>%
  ggplot(aes(x = Per90, y = Value, fill = Per90, color = Per90)) +
  geom_violin(width = 1, size = 0.2) +
  scale_fill_viridis(discrete = T) +
  scale_color_viridis(discrete = T) +
  theme_ipsum() + 
  ggtitle("Distribution of per 90 Values") + 
  xlab("") + 
  ylab("Actual Value per 90") +
  coord_flip() + 
  geom_jitter(alpha = .5, size = 1)
```

When calculating the per 90 values, it is important to consider that a player who has not played a total of 90 minutes in a season will have extremely high per 90 values. Therefore, it is necessary to exclude these values as they are invalid.

```{r transform_4}
performance_data <- performance_data %>% 
  mutate_all(~ifelse(Minutes < 90, NA, .)) %>% 
  na.omit()
```

## Players' Performance

```{r grid_extra}
# plot for points
points_plot <- function(plot_data) {
  plot_data %>%
    select(c("Cost", "Points90")) %>%
    mutate(Value = Points90, Type = "Points90") %>%
    plot()
}

# plot for minutes
minutes_plot <- function(plot_data) {
  plot_data %>%
    select(c("Cost", "Minutes")) %>%
    mutate(Value = Minutes, Type = "Minutes") %>%
    plot()
}

# plot for goals
goals_plot <- function(plot_data) {
  plot_data %>%
    select(c("Cost", "Goals90", "xG90", "xG90_diff")) %>%
    pivot_longer (2:4, names_to = "Type", values_to = "Value") %>%
    plot()
}

# plot for assists
assists_plot <- function(plot_data) {
  plot_data %>%
    select(c("Cost", "Assists90", "xA90", "xA90_diff")) %>%
    pivot_longer (2:4, names_to = "Type", values_to = "Value") %>%
    plot()
}

# plot line chart
plot <- function(data) {
  data %>%
    ggplot(aes(
      x = Cost,
      y = Value,
      group = Type,
      color = Type
    )) +
    geom_line() +
    scale_color_viridis(discrete = TRUE) +
    xlab("Cost(m)") +
    ylab("") +
    theme_ipsum() +
    theme(legend.title = element_blank())
}

plot_data <- performance_data %>% 
  filter(Cost > 8, Cost < 14)

p1 <- points_plot(plot_data)
p2 <- minutes_plot(plot_data)
p3 <- goals_plot(plot_data)
p4 <- assists_plot(plot_data)

grid.arrange(p1, p2, p3, p4, ncol = 2)

```



## Penalty Takers


Lollipop chart






high value(premium) players have a higher conver rate, are closer to the expected values

data_transform, divide players by group, step = 1

will club make a high xG coverted rate player to be a pk taker?

Let take a look at the per 90 values.

Outlier should be players play less than 90, so their per90 values are extremely high. Transfer these data into NA, because when we are trying to analyse the performance of players by using the per90 data, these players who played less than 90 mins make no sense.


# Conclusion

Let return to the top 30 players, after the discussions above, we can find out that xxx. Use a heatmap to verify our observation.

```{r heatmap, fig.height=6, fig.width=8}
# select the top 30 players
plot_data <- performance_data %>%
  arrange(-Points) %>%
  head(30) %>%
  mutate(
    Position_name = paste(Position, Player, sep = " - "),
    Side_color = case_when(
      Position == Positions[1] ~ "#7fc97f",
      Position == Positions[2] ~ "#386cb0",
      Position == Positions[3] ~ "red",
      Position == Positions[4] ~ "#fdb462"
    )
  )

# create heatmap data
heatmap_data <- plot_data %>%
  select(Points:CS90) %>%
  as.matrix()

# color, green for below average, blue for above average
color_1 <-
  colorRampPalette(colors = c('#00FF87', '#33CCFF'))(6)[1:5]
color_2 <- colorRampPalette(colors = c('#33CCFF', '#5190FF'))(6)

# classify general stats, attack stats and defense stats
col_side_color <-
  case_when(
    attr(heatmap_data, which = "dimnames")[[2]] %in% c(
      "Goals90",
      "xG90",
      "xG90_diff",
      "Assists90",
      "xA90",
      "xA90_diff"
    ) ~ "#ec7014",
    attr(heatmap_data, which = "dimnames")[[2]] %in% c(
      "CS90", 
      "GC90", 
      "xGC90", 
      "xGC90_diff"
    ) ~ "#737373",
    .default = "purple"
  )

# plot
heatmap(
  heatmap_data,
  labRow = plot_data$Position_name,
  scale = "column",
  col = c(color_1, color_2),
  cexRow = 1.2,
  cexCol = 1.2,
  RowSideColors = plot_data$Side_color,
  ColSideColors = col_side_color
)

# add legends
legend(
  "topleft",
  legend = c(
    "Potion - FWD",
    "Potion - MID",
    "Potion - DEF",
    "Potion - GKP",
    "General",
    "Offensive",
    "Defensive",
    "Above average",
    "Average",
    "Below Average"
  ),
  cex = 0.6,
  pt.cex = 1,
  fill = c(
    "#7fc97f",
    "#386cb0",
    "red",
    "#fdb462",
    "purple",
    "#ec7014",
    "#737373",
    "#5190FF",
    "#33CCFF",
    "#00FF87"
  )
)
```

# Reference

1. ["English football league system"](https://en.wikipedia.org/wiki/English_football_league_system). *en.wikipedia.org.*
2. ["How Many Play FPL?"](https://allaboutfpl.com/2022/06/number-of-people-who-played-fpl-each-season-how-many-play-fpl/). *allaboutfpl.com.*
3. ["Fantasy_Premier_League"](https://en.wikipedia.org/wiki/Fantasy_Premier_League). *en.wikipedia.org.*
4. ["Fantasy Premier League Dataset 2022-2023"](https://www.kaggle.com/datasets/meraxes10/fantasy-premier-league-dataset-2022-2023). *www.kaggle.com*
5. ["Official Website Fantasy Premier League"](https://fantasy.premierleague.com/). *fantasy.premierleague.com*
6. ["Fantasy football (association)"](https://en.wikipedia.org/wiki/Fantasy_football_(association)). *en.wikipedia.org.*
7. ["Official Website Fantasy Premier League Rules"](https://fantasy.premierleague.com/help/rules). *fantasy.premierleague.com*
8. ["How are points awarded?"](https://www.premierleague.com/news/2173986). *fantasy.premierleague.com*
9. ["expected-goals-xg-explained"](https://statsbomb.com/soccer-metrics/expected-goals-xg-explained/). *statsbomb.com*
10. ["what-are-expected-assists-xa"](https://theanalyst.com/eu/2021/03/what-are-expected-assists-xa/). *theanalyst.com*
11. [“xG, xA, xGI and xGC: What are expected stats and who are the best FPL picks?”](https://fantasyfootballcommunity.com/xg-xa-xgi-and-xgc-what-are-expected-stats-and-who-are-the-best-fpl-picks/).



98. ["TheDataDigest"](https://www.youtube.com/@TheDataDigest). *www.youtube.com*
99. ["Equitable Equations"](https://www.youtube.com/@EquitableEquations). *www.youtube.com*

[ref1]: https://en.wikipedia.org/wiki/English_football_league_system
[ref2]: https://allaboutfpl.com/2022/06/number-of-people-who-played-fpl-each-season-how-many-play-fpl/
[ref3]: https://en.wikipedia.org/wiki/Fantasy_Premier_League
[ref4]: https://www.kaggle.com/datasets/meraxes10/fantasy-premier-league-dataset-2022-2023
[ref5]: https://fantasy.premierleague.com/
[ref6]: https://en.wikipedia.org/wiki/Fantasy_football_(association)
[ref7]: https://fantasy.premierleague.com/help/rules
[ref8]: https://www.premierleague.com/news/2173986
[ref9]: https://statsbomb.com/soccer-metrics/expected-goals-xg-explained/
[ref10]: https://theanalyst.com/eu/2021/03/what-are-expected-assists-xa/
[ref11]: https://fantasyfootballcommunity.com/xg-xa-xgi-and-xgc-what-are-expected-stats-and-who-are-the-best-fpl-picks/

