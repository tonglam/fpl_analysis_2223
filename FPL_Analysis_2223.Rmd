---
title: "FPL_Analysis_2223"
author: "Tong Lan"
date: "`r Sys.Date()`"
output: 
  html_document: 
    code_folding: show
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_chunk$set(warning = FALSE)
```

# **CITS4009 - Project 1**

## Tong LAN (24056082)

## Introduction

The **Premier League** (legal name: **The Football Association Premier League Limited**) represents the highest level of the [English football league system](https://en.wikipedia.org/wiki/English_football_league_system). Twenty clubs compete against each other, with each team playing 38 matches, resulting in a total of 380 matches every season.

(<https://en.wikipedia.org/wiki/Premier_League>)

The dataset used in this project is obtained from [*kaggle.com*](https://www.kaggle.com/), collected by *PAOLO MAZZA*. It contains

Fantasy Premier League(FPL) is the official fantasy football game of English Premier League, played nearly by 8 million managers all across the globe.

The Premier League, also known as the English Premier League or the EPL, is the top level of the English football league system. Contested by 20 clubs, it operates on a system of promotion and relegation with the English Football League. Seasons typically run from August to May with each team playing 38 matches.

<https://www.kaggle.com/datasets/meraxes10/fantasy-premier-league-dataset-2022-2023>

## Goal of the project

This project is for exploring the data of 2011-12 season FPL data, find out the relatinship between players and their overall_points, base on their playing position and their value in the FPL.

## Data loading

### load library

```{r load library, message=FALSE}
library(shiny)
library(tidyverse)
library(hrbrthemes)
library(viridis)
library(fmsb)
library(ggrepel)
library(gridExtra)
```

#### load data.csv

```{r load data file, message=FALSE}
path <- "./FPL_Dataset_2022-2023.csv"
fpl_raw_data <- read.csv(path)
```

#### overview the data

```{r glimpse, results='hide'}
glimpse(fpl_raw_data)
```


```{r str, results='hide'}
str(fpl_raw_data)
```

From the structure of the data we can see, there is 713 rows and 19 columns. Next, we use summary() to glimpse the data. We can find out that each row presents a player, so we have 713 players for the 11-12 season, a player get total points from -3 to 244. average is 28, it is a huge range. Then, we can view the default first 6 rows by use head() function, it shows that each row contains many details including how many goals each player scores, assists and so on.

```{r summary, results='hide'}
summary(fpl_raw_data)
```

```{r head, results='hide'}
head(fpl_raw_data)
```

# Initial transform

The next step we try to do is transforming the data, for a easy understanding. For our goal in this project, we should cut the raw data, and remain field of the below list: First_Name, Second_Name, Club, Position, Total_Points. And we can combine the row "First_Name" and row "Second_Name" to a new Row "Name". So, we create a subset named "fpl_data" for further explore. After that, let's take a look at the structure of fpl_data. Transform the data frame into tibble makes it easiler to manipulate.

Rank the players based on their total_point, adding a new column named "Rank" before column "Name".

```{r transform, echo=TRUE}
# get level function
get_cost_level <- function(cost_bin) {
  level <- levels(cut_interval((fpl_raw_data$now_cost)/10, 3))
  case_when(
    cost_bin == level[1] ~ "Low",
    cost_bin == level[2] ~ "Middle",
    cost_bin == level[3] ~ "Premium",
    .default = NA
  )
}

# transform data
fpl_data <- fpl_raw_data[c(
  "web_name",
  "team",
  "position",
  "total_points",
  "points_per_game",
  "now_cost",
  "minutes",
  "goals_scored",
  "expected_goals",
  "expected_goals_per_90",
  "assists",
  "expected_assists",
  "expected_assists_per_90",
  "goals_conceded",
  "expected_goals_conceded",
  "expected_goals_conceded_per_90",
  "saves",
  "saves_per_90",
  "clean_sheets",
  "clean_sheets_per_90"
)] %>%
  
  rename(all_of(
    c(
      Player = "web_name",
      Club = "team",
      Position = "position",
      Points = "total_points",
      Points90 = "points_per_game",
      Cost = "now_cost",
      Minutes = "minutes",
      Goals = "goals_scored",
      xG = "expected_goals",
      xG90 = "expected_goals_per_90",
      Assists = "assists",
      xA = "expected_assists",
      xA90 = "expected_assists_per_90",
      GC = "goals_conceded",
      xGc = "expected_goals_conceded",
      xGc90 = "expected_goals_conceded_per_90",
      Saves = "saves",
      Saves90 = "saves_per_90",
      CS = "clean_sheets",
      CS90 = "clean_sheets_per_90"
    )
    
  )) %>%
  
  # cost is 10 times larger because it is easier to store a integer in the database
  # now we can return it to the actual value by diving 10
  mutate(Cost = Cost / 10) %>%
  
  # separate the player into three group by their values
  mutate(Cost_bin = cut_interval(Cost, 3), .after = Cost) %>% 
  
  # category player level by their values
  mutate(Level = get_cost_level(Cost_bin), .after = Cost_bin)

# remove data: fpl_raw_data to save memory
  rm(fpl_raw_data)

# show the table(first six rows)
knitr::kable(fpl_data[1:5,], caption =  "first 5 rows of fpl_data")
```

```{r constants, include=FALSE}
Positions <-  c("FWD", "MID", "DEF", "GKP")
Positions_All <-  c("ALL", Positions)
Levels <- unique(fpl_data$Level)
Clubs <- unique(fpl_data$Club)
Costs <- seq(from = 4, to = 13.5, by = 0.5)
```

# visualize

## top 50 players

```{r desity}
fpl_data %>%
  ggplot(aes(x = Points)) +
  geom_density(fill = "#69b3a2",
               color = "#e9ecef",
               alpha = 0.8) +
  ggtitle("Points distribution of players(more than 10000 mins)") +
  ylab("") +
  theme_ipsum()
```

# multiple desity, group by position

```{r multiple desity}
fpl_data %>%
  ggplot(aes(x = Points, group = Position, fill = Position)) +
  geom_density(adjust = 1.5, alpha = 0.4) +
  ylab("") +
  theme_ipsum()
```

# look at the top 30 players

```{r barplot, fig.height=12}
fpl_data %>%
  arrange(-Points) %>%
  head(50) %>%
  mutate(Player = fct_reorder(Player, Points)) %>%
  ggplot(aes(x = Player, y = Points, fill = Position)) +
  geom_bar(stat = "identity",
           alpha = 0.8,
           width = 0.8) +
  geom_label(
    aes(y = Points, label = Points),
    position = position_stack(vjust = 1),
    size = 3,
    show.legend = F
  ) +
  coord_flip() +
  scale_color_brewer(palette = 3) +
  xlab("") +
  theme_ipsum()
```

# points and positons

```{r shiny_multiple_distribution_plot}
ui <- fluidPage(sidebarLayout(
  sidebarPanel(
    selectInput(
      "type",
      "Chart Type",
      choices = list(
        "boxplot" = 1,
        "violin" = 2,
        "donut" = 3
      ),
      selected = 1
    ),
    
    checkboxGroupInput(
      "positions",
      "Position",
      choices = list(
        "FWD" = "FWD",
        "MID" = "MID",
        "DEF" = "DEF",
        "GKP" = "GKP"
      ),
      selected = Positions
    ),
    
    checkboxGroupInput(
      "levels",
      "Levels",
      choices = list(
        "Premium" = "Premium",
        "Middle" = "Middle",
        "Low" = "Low"
      ),
      selected = Levels
    ),
    
  ),
  
  mainPanel(plotOutput("plot"),
            tableOutput("table"))
  
))



server <- function(input, output) {
  output$plot <- renderPlot({
    # all selected position
    positions <- input$positions
    # all selected levels
    levels <- input$levels
    # filter
    plot_data <-
      fpl_data %>% filter(Position %in% positions, Level %in% levels)
    # type
    if (nrow(plot_data) == 0) {
      return (NULL)
    }
    plot_type = input$type
    if (plot_type == 1) {
      blox(plot_data)
    } else if (plot_type == 2) {
      violin(plot_data)
    } else if (plot_type == 3) {
      donut(plot_data)
    }
  })
  
  
  # plot_functions
  blox <- function(plot_data) {
    plot_data %>%
      ggplot(aes(x = Level, y = Points, fill = Position)) +
      geom_boxplot() +
      scale_fill_viridis(discrete = TRUE, alpha = 0.6) +
      geom_jitter(color = "black",
                  size = 0.4,
                  alpha = 0.9) +
      xlab("") +
      theme_ipsum()
    
  }
  
  violin <- function(plot_data) {
    plot_data %>%
      ggplot(aes(x = Level, y = Points, fill = Position)) +
      geom_violin(alpha = .6) +
      xlab("") +
      theme_ipsum()
  }
  
  donut <- function(plot_data) {
    # the beauty of pipeline %>%
    aggregate(plot_data$Points,
              by = list(Position = plot_data$Position),
              FUN = sum) %>%
      mutate(
        percentage = x / sum(x),
        ymax = cumsum(percentage),
        ymin = c(0, head(ymax, n = -1)),
        labelPosition = (ymax + ymin) / 2,
        label = paste(Position,
                      "\n",
                      round(percentage, 2) * 100,
                      "%",
                      sep = "")
      ) %>%
      ggplot(aes(
        ymax = ymax,
        ymin = ymin,
        xmax = 4,
        xmin = 3,
        fill = Position
      )) +
      geom_rect() +
      coord_polar(theta = "y") +
      geom_label(x = 3.5,
                 aes(y = labelPosition, label = label),
                 size = 5) +
      scale_fill_brewer(palette = 4) +
      scale_color_brewer(palette = 3) +
      xlim(c(2, 4)) +
      theme_void() +
      theme(legend.position = "none")
  }
  
  #TODO table here
  output$table <- renderTable({
    
  })
  
}

shinyApp(ui, server)
```

# values and points
```{r shiny_scatter}
ui <- fluidPage(sidebarLayout(sidebarPanel(
  sliderInput(
    "value_range",
    "Value Range",
    min = 3.5,
    max = 13.5,
    value = c(6, 10),
    step = 0.1
  )
),
mainPanel(plotOutput("scatter"))))

server <- function(input, output) {
  output$scatter <- renderPlot({
    plot_data <- fpl_data %>%
      filter(Points > 50) %>%
      filter(Cost >= input$value_range[1], Cost <= input$value_range[2])
    
    ggplot(plot_data, aes(x = Points, y = Cost)) +
      geom_point(aes(color = Position, shape = Position),
                 size = 1.5,
                 alpha = 0.8) +
      scale_color_manual(values = c("#386cb0", "#fdb462", "#7fc97f", "red")) +
      geom_text_repel(
        aes(label = Player),
        family = "Poppins",
        size = 3,
        min.segment.length = 0,
        seed = 42,
        box.padding = 0.5,
        max.overlaps = Inf,
        nudge_x = .15,
        nudge_y = .5,
        color = "grey50"
      ) +
      labs(
        title = "Compare Players Points",
        subtitle = "compare players in the value range",
        x = "total_points",
        y = "cost(m)"
      ) +
      theme(
        # The default font when not explicitly specified
        text = element_text(
          family = "Lobster Two",
          size = 8,
          color = "black"
        ),
        
        # Customize legend text, position, and background.
        legend.text = element_text(size = 9, family = "Roboto"),
        legend.position = c(1, 0),
        legend.justification = c(1, 0),
        legend.background = element_blank(),
        # This one removes the background behind each key in the legend
        legend.key = element_blank(),
        
        # Customize title and subtitle font/size/color
        plot.title = element_text(
          family = "Lobster Two",
          size = 20,
          face = "bold",
          color = "#2a475e"
        ),
        plot.subtitle = element_text(
          family = "Lobster Two",
          size = 15,
          face = "bold",
          color = "#1b2838"
        ),
        plot.title.position = "plot",
        
        # Adjust axis parameters such as size and color.
        axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 12),
        axis.ticks = element_blank(),
        # Axis lines are now lighter than default
        axis.line = element_line(colour = "grey50"),
        
        # Only keep y-axis major grid lines, with a grey color and dashed type.
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "#b4aea9", linetype =
                                            "dashed"),
        
        # Use a light color for the background of the plot and the panel.
        panel.background = element_rect(fill = "#fbf9f4", color = "#fbf9f4"),
        plot.background = element_rect(fill = "#fbf9f4", color = "#fbf9f4")
      )
    
  })
}

shinyApp(ui, server)
```


# high value(premium) players have a higher conver rate, are closer to the expected values

# data_transform, divide players by group, step = 1
```{r shiny_radar}
# different position compare different data in radar chart
get_radarCols <- function(Position) {
  if (Position == 'FWD' | Position == 'MID') {
    return (c(
      "Points",
      "Assists",
      "xA",
      "xA90",
      "Minutes",
      "xG90",
      "xG",
      "Goals"
    ))
  } else if (Position == 'DEF') {
    return (c(
      "Points",
      "GC",
      "xGc",
      "xGc90",
      "Minutes",
      "CS90",
      "CS",
      "Points90"
    ))
  } else{
    return (c(
      "Points",
      "GC",
      "xGc",
      "xGc90",
      "Minutes",
      "Saves90",
      "Saves",
      "Points90"
    ))
  }
}


ui <- fluidPage(sidebarLayout(
  sidebarPanel(tabsetPanel(
    tabPanel(
      "Player 1",
      br(),
      # player1
      selectInput("club1",
                  "Club",
                  choices = Clubs,
                  selected = Clubs[1]),
      
      selectInput(
        "position1",
        "Position",
        choices = Positions,
        selected = Positions[1]
      ),
      
      selectInput("player1",
                  "Name",
                  choices = NULL),
      
      textInput("value1",
                "Value",
                value = NULL)
      
    ),
    
    tabPanel(
      "Player 2",
      br(),
      # player2
      selectInput("club2",
                  "Club",
                  choices = Clubs,
                  selected = Clubs[1]),
      
      selectInput("position2",
                  "Position",
                  choices = NULL),
      
      
      selectInput("player2",
                  "Name",
                  choices = NULL),
      
      textInput("value2",
                "Value",
                value = NULL),
    )
  )),
  mainPanel(plotOutput("radar"), tableOutput("table"))
))


server <- function(input, output, session) {
  # player 1 filter
  player1_filter <- reactive({
    fpl_data %>%
      filter(Club == input$club1, Position == input$position1) %>%
      arrange(desc(Cost))
  })
  
  observeEvent(player1_filter(), {
    choices <- unique(player1_filter()$Player)
    updateSelectInput(inputId = "player1", choices = choices)
  })
  
  # player 2 filter
  player2_filter <- reactive({
    fpl_data %>%
      filter(Club == input$club2,
             Position == input$position2,
             Player != input$player1) %>%
      arrange(desc(Cost))
  })
  
  observeEvent(player2_filter(), {
    choices <- unique(player2_filter()$Player)
    updateSelectInput(inputId = "player2", choices = choices)
  })
  
  # player 2 position depends on player 1
  observeEvent(input$position1, {
    updateSelectInput(inputId = "position2", choices = c(input$position1))
  })
  
  # player 1 value depends on player 1 name
  player1_value_filter <- reactive({
    value_player <-  fpl_data %>%
      filter(Player == input$player1)
    value_player$Cost
  })
  
  observeEvent(input$player1, {
    player1_value_text <- paste0(player1_value_filter(), "m", seq = "")
    updateTextInput(inputId = "value1", value = player1_value_text)
  })
  
  # player 2 value depends on player 2 name
  player2_value_filter <- reactive({
    value_player <-  fpl_data %>%
      filter(Player == input$player2)
    value_player$Cost
  })
  
  observeEvent(input$player2, {
    player2_value_text <- paste0(player2_value_filter(), "m", seq = "")
    updateTextInput(inputId = "value2", value = player2_value_text)
  })
  
  # radar data
  radar_data_filter <- reactive({
    # organize data
    req(input$player1)
    req(input$player2)
    radarCols <- get_radarCols(input$position1)
    fpl_data %>%
      filter(Player %in% c(input$player1, input$player2)) %>%
      select(all_of(radarCols))
  })
  
  output$radar <- renderPlot({
    radarCols <- get_radarCols(input$position1)
    plot_data <- radar_data_filter()
    plot_data <-
      rbind(c(
        max(fpl_data[radarCols[1]]),
        max(fpl_data[radarCols[2]]),
        max(fpl_data[radarCols[3]]),
        max(fpl_data[radarCols[4]]),
        max(fpl_data[radarCols[5]]),
        max(fpl_data[radarCols[6]]),
        max(fpl_data[radarCols[7]]),
        max(fpl_data[radarCols[8]])
      ),
      rep(0, 8),
      plot_data)
    
    # color vector
    colors_border = c(rgb(0.2, 0.5, 0.5, 0.9),
                      rgb(0.8, 0.2, 0.5, 0.9),
                      rgb(0.7, 0.5, 0.1, 0.9))
    
    colors_in = c(rgb(0.2, 0.5, 0.5, 0.4),
                  rgb(0.8, 0.2, 0.5, 0.4),
                  rgb(0.7, 0.5, 0.1, 0.4))
    
    # plot with default options:
    radarchart(
      plot_data,
      axistype = 1 ,
      #custom polygon
      pcol = colors_border ,
      pfcol = colors_in ,
      plwd = 4 ,
      plty = 1,
      #custom the grid
      cglcol = "grey",
      cglty = 1,
      axislabcol = "grey",
      caxislabels = seq(0, 20, 5),
      cglwd = 0.8,
      #custom labels
      vlcex = 0.8
    )
    
    # add a legend
    legend(
      x = 1.2,
      y = 1,
      legend = c(input$player1, input$player2),
      bty = "n",
      pch = 20 ,
      col = colors_in ,
      text.col = "grey",
      cex = 1.2,
      pt.cex = 3
    )
  })
  
  #TODO table here
  output$table <- renderTable({
    
  })
  
}


shinyApp(ui, server)
```


# will club make a high xG coverted rate player to be a pk taker?

```{r expected value diff, results='hide'}
# fpl_data_diff
fpl_data <- fpl_data %>%
  mutate(xG_diff = Goals - xG, .after = xG) %>%
  mutate(xA_diff = Assists - xA, .after = xA) %>%
  mutate(xGc_diff = GC - xGc, .after = xGc) %>%
  mutate(Goals90 = Goals / (Minutes / 90), .before = xG90) %>%
  mutate(xG90_diff = Goals90 - xG90, .after = xG90) %>%
  mutate(Assists90 = Assists / (Minutes / 90), .before = xA90) %>%
  mutate(xA90_diff = Assists90 - xA90, .after = xA90) %>%
  mutate(GC90 = GC / (Minutes / 90), .before = xGc90) %>%
  mutate(xGc90_diff = GC90 - xGc90, .after = xGc90)

# new data table
knitr::kable(fpl_data[1:5, ], caption = "first 5 rows of fpl_data after adding diff and avg_90 data")
```

```{r expeceted value cleaning}
# count misssing values
missing_values <- apply(is.na(fpl_data), 2, sum)
na_values <- which(missing_values > 0)
# if actual value and expected value are all 0, then the actual value 90 and expected value 90 will be NaN
# if min > 0, give it an average value, others it is 0
#  expected90 values nan means the player did not play a single minute, make it NA
  fpl_data$Goals90 <- ifelse(is.na(fpl_data$Goals90), 0, fpl_data$Goals90)
  fpl_data$Assists90 <- ifelse(is.na(fpl_data$Assists90), 0, fpl_data$Assists90)
  fpl_data$GC90 <- ifelse(is.na(fpl_data$GC90), 0, fpl_data$GC90)
  fpl_data$xG90_diff <- fpl_data$Goals90 - fpl_data$xG90
  fpl_data$xA90_diff <- fpl_data$Assists90 - fpl_data$xA90
  fpl_data$xGc90_diff <- fpl_data$GC90 - fpl_data$xGc90
# look at the missing values again, it is clean
missing_values <- apply(is.na(fpl_data), 2, sum)
```


```{r shiny_gridExtra}
# select choices
goals_max <- max(fpl_data$Goals)
assists_max <- max(fpl_data$Assists)
gc_max <- max(fpl_data$GC)


ui <- fluidPage(sidebarLayout(
  sidebarPanel(
    checkboxGroupInput(
      "positions",
      "Position",
      choices = list(
        "FWD" = "FWD",
        "MID" = "MID",
        "DEF" = "DEF",
        "GKP" = "GKP"
      ),
      selected = Positions
    ),
    
    sliderInput(
      "goals",
      "Goals From",
      min = 1,
      max = goals_max,
      value = c(25, goals_max),
      step = 1
    ),
    
    sliderInput(
      "assists",
      "Assists From",
      min = 1,
      max = assists_max,
      value = c(5, assists_max),
      step = 1
    ),
    
    sliderInput(
      "gc",
      "Goals Concede From",
      min = 1,
      max = gc_max,
      value = c(gc_max, 5),
      step = 5
    ),
    
  ),
  
  mainPanel(plotOutput("plot"))
  
))

server <- function(input, output) {
  plot_data <-
    
    output$plot <- renderPlot({
    
      # p1: Goals and xG
      goals_data <- fpl_data %>% 
        filter(Goals >= input$goals[1], Goals <= input$goals[2]) %>% 
        select(c("Cost", "Goals90", "xG90"))
      
      print(goals_data)
      
      # create a new data frame for plot[Cost, Value, Type]
      # need to reshape data here, make a n*3 data frame to 2n*2
      plot_goals_data <- pivot_longer (goals_data, 
                                 direction = "long",
                                 varying = list(c("Goals90", "xG90")),
                                 v.names = ,
                                 timevar = ,
                                 times = c("Goals90", "xG90"))
      
      View(plot_goals_data)
      
    #  p1 %>%
    # ggplot( aes(x=year, y=n, group=name, color=name)) +
    # geom_line() +
    # scale_color_viridis(discrete = TRUE) +
    # ggtitle("Popularity of American names in the previous 30 years") +
    # theme_ipsum() +
    # ylab("Number of babies born")
    #     
    #     
        
        
      #   plot_goals_data %>%
      #   ggplot(aes(x = value, fill = type)) +
      #   geom_histogram(color = "#e9ecef",
      #                  alpha = 0.6,
      #                  position = 'identity') +
      #   scale_fill_manual(values = c("#69b3a2", "#404080")) +
      #   theme_ipsum() +
      #   labs(fill = "")
      # 
      # 
      # p1
      
    })
  
  
}

shinyApp(ui, server)
```



